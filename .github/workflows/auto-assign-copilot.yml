# .github/workflows/auto-assign-copilot.yaml
name: Auto-assign Copilot on Copilot tasks
on:
  issues:
    types: [opened]

jobs:
  assign:
    name: Assign Copilot to task
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue
            
            console.log('ü§ñ Auto-assign Copilot workflow started')
            console.log(`üìã Issue #${issue.number}: "${issue.title}"`)
            console.log(`üè∑Ô∏è  Labels: ${issue.labels.map(l => l.name).join(', ')}`)
            
            // Adjust condition to your template (label, title prefix, or issue type)
            const titleMatches = issue.title.startsWith("[Copilot]: ")
            const labelMatches = issue.labels.some(l => l.name.toLowerCase() === "robot :robot:")
            const isCopilotTask = titleMatches || labelMatches
            
            console.log(`üîç Title starts with "[Copilot]: ": ${titleMatches}`)
            console.log(`üîç Has "robot :robot:" label: ${labelMatches}`)
            console.log(`‚úÖ Is Copilot task: ${isCopilotTask}`)

            if (isCopilotTask) {
              console.log('üéØ Attempting to assign Copilot to the issue...')
              try {
                // Try assigning the Copilot app (some orgs allow this)
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  assignees: ["Copilot"]   // if this fails, fall back below
                })
                console.log('‚úÖ Successfully assigned Copilot to the issue!')
              } catch (e) {
                console.log(`‚ùå Failed to assign Copilot: ${e.message}`)
                console.log('üîÑ Falling back to assign rempsyc...')
                try {
                  // Fallback: assign to you, keep the label so Copilot still picks it up
                  await github.rest.issues.addAssignees({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    assignees: ["rempsyc"]
                  })
                  console.log('‚úÖ Successfully assigned rempsyc as fallback!')
                } catch (fallbackError) {
                  console.log(`‚ùå Failed to assign fallback: ${fallbackError.message}`)
                  throw fallbackError
                }
              }
            } else {
              console.log('‚è≠Ô∏è  Skipping assignment - not a Copilot task')
            }
            
            console.log('üèÅ Auto-assign Copilot workflow completed')
