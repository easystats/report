# .github/workflows/auto-assign-copilot.yaml
name: Auto-assign Copilot on Copilot tasks
on:
  issues:
    types: [opened]

jobs:
  assign:
    name: Assign Copilot to task
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue
            
            console.log('ğŸ¤– Auto-assign Copilot workflow started')
            console.log(`ğŸ“‹ Issue #${issue.number}: "${issue.title}"`)
            console.log(`ğŸ·ï¸  Labels: ${issue.labels.map(l => l.name).join(', ')}`)
            console.log(`ğŸ‘¤ Issue author: ${issue.user.login}`)
            console.log(`ğŸ  Repository: ${context.repo.owner}/${context.repo.repo}`)
            
            // Adjust condition to your template (label, title prefix, or issue type)
            const titleMatches = issue.title.startsWith("[Copilot]: ")
            const labelMatches = issue.labels.some(l => l.name.toLowerCase() === "robot :robot:")
            const isCopilotTask = titleMatches || labelMatches
            
            console.log(`ğŸ” Title starts with "[Copilot]: ": ${titleMatches}`)
            console.log(`ğŸ” Has "robot :robot:" label: ${labelMatches}`)
            console.log(`âœ… Is Copilot task: ${isCopilotTask}`)

            if (isCopilotTask) {
              console.log('ğŸ¯ Attempting to assign Copilot to the issue...')
              try {
                // Try assigning the correct Copilot username (lowercase)
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  assignees: ["copilot"]   // Using lowercase username
                })
                console.log('âœ… Successfully assigned copilot to the issue!')
              } catch (e) {
                console.log(`âŒ Failed to assign copilot: ${e.message}`)
                console.log(`ğŸ” Error details: ${JSON.stringify(e, null, 2)}`)
                console.log('ğŸ”„ Falling back to assign rempsyc...')
                try {
                  // Fallback: assign to rempsyc, keep the label so Copilot still picks it up
                  await github.rest.issues.addAssignees({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    assignees: ["rempsyc"]
                  })
                  console.log('âœ… Successfully assigned rempsyc as fallback!')
                } catch (fallbackError) {
                  console.log(`âŒ Failed to assign fallback rempsyc: ${fallbackError.message}`)
                  console.log(`ğŸ” Fallback error details: ${JSON.stringify(fallbackError, null, 2)}`)
                  console.log('ğŸ’¡ Both assignment attempts failed - this indicates a deeper issue')
                  throw fallbackError
                }
              }
            } else {
              console.log('â­ï¸  Skipping assignment - not a Copilot task')
            }
            
            console.log('ğŸ Auto-assign Copilot workflow completed')
