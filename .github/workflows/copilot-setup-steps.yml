# GitHub Copilot Environment Setup for report R Package
# This workflow sets up the development environment before Copilot starts working
# Based on: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

name: copilot-setup-steps

on:
  workflow_dispatch:
  # This workflow is automatically triggered by GitHub Copilot
  # before the agent starts working in the repository
  pull_request:
    types: [opened, synchronize]

jobs:
  copilot-setup-steps:
    # Optional: only run on Copilot agent commits; remove this if you also want your own pushes to trigger it
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
       github.actor == 'github-copilot')

    runs-on: ubuntu-latest
    
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      _R_CHECK_CRAN_INCOMING_: false
      _R_CHECK_FORCE_SUGGESTS_: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Determine if R setup is needed
        id: check_r_needed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Checking if R environment setup is needed..."

          R_NEEDED=true

          # If this is a PR, use the PR's changed files (authoritative)
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            PR_NUMBER=$(jq -r '.number' < "$GITHUB_EVENT_PATH")
            echo "PR number: $PR_NUMBER"

            # Get changed files from the PR
            FILES=$(curl -sS -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/pulls/${PR_NUMBER}/files?per_page=100" \
              | jq -r '.[].filename')

            echo "Files in PR:"
            echo "${FILES}"

            # If ANY file is not in the "docs/config-only" set -> need R
            # Allowed-only set (docs/config): tweak as you like
            # Note: use a temporary file to avoid word-splitting issues
            echo "${FILES}" > /tmp/pr_files.txt

            if grep -E '\.(R|Rmd|Rd)$' /tmp/pr_files.txt >/dev/null || \
               grep -E '^(R/|tests/|man/|vignettes/|src/)' /tmp/pr_files.txt >/dev/null; then
              echo "Detected R-related paths in PR."
              R_NEEDED=true
            else
              # Anything outside the allowed docs/config list? Then R is needed.
              if grep -v -E '^(\.github/copilot-instructions\.md|\.github/workflows/|README\.md|\.gitignore|\.Rbuildignore|NEWS\.md|CONTRIBUTING\.md|LICENSE|CITATION\.cff|DESCRIPTION|cran-comments\.md|.+\.md$|.+\.ya?ml$)$' /tmp/pr_files.txt | grep -E '.' >/dev/null; then
                echo "Changes go beyond docs/config-only."
                R_NEEDED=true
              else
                echo "PR is docs/config-only."
                R_NEEDED=false
              fi
            fi

          else
            # No PR context (Copilot run, pushes, etc.)
            # Fallback: fast probe + light heuristics

            echo "No PR context; using probe/heuristics."

            # Example probe: if R already present and renv/cache present, skip
            if command -v R >/dev/null 2>&1 && [ -f "renv.lock" ] && [ -d "~/.cache/R" ]; then
              echo "R and cache present; likely no heavy setup needed."
              R_NEEDED=false
            else
              # Last-commit heuristic (with full history available)
              # Compare against the immediate parent only, to avoid "recent history" bias
              if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
                CHANGED=$(git diff --name-only HEAD~1...HEAD || true)
              else
                CHANGED=$(git ls-files) # first run in a new repo clone
              fi
              echo "${CHANGED}" > /tmp/changed.txt

              if grep -E '\.(R|Rmd|Rd)$' /tmp/changed.txt >/dev/null || \
                 grep -E '^(R/|tests/|man/|vignettes/|src/)' /tmp/changed.txt >/dev/null; then
                R_NEEDED=true
              else
                if grep -v -E '^(\.github/copilot-instructions\.md|\.github/workflows/|README\.md|\.gitignore|\.Rbuildignore|NEWS\.md|CONTRIBUTING\.md|LICENSE|CITATION\.cff|DESCRIPTION|cran-comments\.md|.+\.md$|.+\.ya?ml$)$' /tmp/changed.txt | grep -E '.' >/dev/null; then
                  R_NEEDED=true
                else
                  R_NEEDED=false
                fi
              fi
            fi
          fi

          echo "R_NEEDED=${R_NEEDED}" | tee -a "$GITHUB_OUTPUT"
          
          echo ""
          echo "=== FINAL DECISION ==="
          if [ "$R_NEEDED" == "true" ]; then
            echo "✓ R setup WILL be run"
            echo "Reason: Analysis indicates R functionality is needed"
          else
            echo "✓ R setup WILL BE SKIPPED"
            echo "Reason: Only documentation/config files detected"
          fi
          echo "Decision: R_NEEDED=$R_NEEDED"
        
      - name: Setup R
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true
          
      - name: Setup pandoc (required for building vignettes)
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        uses: r-lib/actions/setup-pandoc@v2

      - name: Install system dependencies
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            r-base-dev

      - name: Setup R user library
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        run: |
          mkdir -p ~/R/library
          echo 'R_LIBS_USER=~/R/library' >> ~/.Renviron
        shell: bash

      - name: Cache R packages
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        uses: actions/cache@v3
        with:
          path: ~/.local/share/renv
          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      - name: Install core R development packages
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        run: |
          # Install essential development packages first
          install.packages(c(
            "rlang",
            "dplyr", 
            "testthat",
            "lintr",
            "styler", 
            "roxygen2",
            "reprex",
            "devtools",
            # Dependencies specifically needed for reprex functionality
            "knitr",
            "rmarkdown",
            "clipr"
          ), repos = "https://cloud.r-project.org/")
        shell: Rscript {0}
        
      - name: Install report package dependencies (Imports only)
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        run: |
          # Install only required dependencies (Imports) to save time and resources
          # Suggested packages are NOT installed by default and should be 
          # installed "as necessary" based on the specific PR requirements
          # This follows the copilot instructions philosophy of targeted installation
          tryCatch({
            install.packages("remotes", repos = "https://cloud.r-project.org/")
            remotes::install_deps(dependencies = c("Depends", "Imports"))
          }, error = function(e) {
            cat("Warning: Some dependencies may not have installed:", e$message, "\n")
          })
        shell: Rscript {0}

      - name: Build report package
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        run: |
          # Build the current package
          system("R CMD build .")
        shell: Rscript {0}
        
      - name: Install report package  
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        run: |
          # Install the built package
          pkg_file <- list.files(pattern = "report_.*\\.tar\\.gz")[1]
          if (!is.na(pkg_file)) {
            system(paste("R CMD INSTALL", pkg_file))
          } else {
            # Fallback: install from source
            system("R CMD INSTALL .")
          }
        shell: Rscript {0}

      - name: Verify R installation and packages
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        run: |
          cat("=== R Version ===\n")
          print(R.version.string)
          
          cat("\n=== Core Development Packages ===\n")
          required_packages <- c("rlang", "dplyr", "testthat", "lintr", "styler", "roxygen2", "reprex", "knitr", "rmarkdown", "clipr")
          for (pkg in required_packages) {
            if (requireNamespace(pkg, quietly = TRUE)) {
              cat("✓", pkg, "- version", as.character(packageVersion(pkg)), "\n")
            } else {
              cat("✗", pkg, "- NOT AVAILABLE\n")
            }
          }
          
          cat("\n=== report Package ===\n") 
          if (requireNamespace("report", quietly = TRUE)) {
            library(report)
            cat("✓ report - version", as.character(packageVersion("report")), "\n")
          } else {
            cat("✗ report - NOT AVAILABLE\n")
          }
        shell: Rscript {0}

      - name: Test core report functionality
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        run: |
          library(report)
          
          cat("=== Testing Core Functions ===\n")
          
          # Test basic report function
          tryCatch({
            data(mtcars)
            model <- lm(mpg ~ wt + hp, data = mtcars)
            result <- report(model)
            cat("✓ report() works\n")
          }, error = function(e) {
            cat("⚠ report() error:", e$message, "\n")
          })
          
          # Test data frame reporting
          tryCatch({
            report_data <- report(mtcars)
            cat("✓ report(data.frame) works\n")
          }, error = function(e) {
            cat("⚠ report(data.frame) error:", e$message, "\n")
          })
          
          # Test sample reporting
          tryCatch({
            sample_report <- report_sample(mtcars)
            cat("✓ report_sample() works\n")
          }, error = function(e) {
            cat("⚠ report_sample() error:", e$message, "\n")
          })
          
          # Test participants reporting
          tryCatch({
            test_data <- data.frame(Age = c(25, 30, 35), Sex = c("F", "M", "F"))
            participants_report <- report_participants(test_data)
            cat("✓ report_participants() works\n")
          }, error = function(e) {
            cat("⚠ report_participants() error:", e$message, "\n")
          })
          
          cat("\n=== Core Function Tests Complete ===\n")
        shell: Rscript {0}

      - name: Test reprex functionality  
        if: steps.check_r_needed.outputs.R_NEEDED == 'true'
        env:
          CLIPR_ALLOW: true
        run: |
          library(reprex)
          library(report)
          
          cat("=== Testing reprex Functionality ===\n")
          
          # Test reprex with report function
          test_code <- "
          library(report)
          data(mtcars)
          
          # Test basic model reporting
          model <- lm(mpg ~ wt + hp, data = mtcars)
          result <- report(model)
          print(result)
          "
          
          tryCatch({
            reprex_result <- reprex(input = test_code, venue = "gh", advertise = FALSE, show = FALSE, html_preview = FALSE)
            
            if (length(reprex_result) > 0 && any(grepl("library\\(report\\)", reprex_result))) {
              cat("✓ reprex is working correctly with report\n")
              cat("Sample reprex output (first 10 lines):\n")
              cat(paste(head(reprex_result, 10), collapse = "\n"), "\n")
              
              # Check for complete reprex format including session info
              if (any(grepl("Created on", reprex_result)) || any(grepl("reprex v", reprex_result))) {
                cat("✓ Complete reprex format with session info detected\n")
              } else {
                cat("⚠ reprex output may be incomplete - missing session info\n")
              }
            } else {
              cat("⚠ reprex generated output but may not be working correctly\n")
            }
          }, error = function(e) {
            cat("✗ reprex failed:", e$message, "\n")
            cat("This may be due to missing dependencies or environment issues\n")
          })
          
          cat("\n=== reprex Test Complete ===\n")
        shell: Rscript {0}

      - name: Display environment summary
        run: |
          echo "=== GitHub Copilot Environment Setup Complete ==="
          echo ""
          
          if [ "${{ steps.check_r_needed.outputs.R_NEEDED }}" == "true" ]; then
            echo "✓ Full R development environment configured:"
            echo "  - R and system dependencies installed"
            echo "  - report package built and installed"
            echo "  - Core development tools available (lintr, styler, roxygen2)"
            echo "  - Complete reprex setup (reprex + knitr + rmarkdown + pandoc)"
            echo "  - ONLY required dependencies (Imports) installed to save time"
            echo "  - Suggested packages NOT installed - install as needed per PR"
            echo "  - Package building and testing capabilities verified"
            echo ""
            echo "The environment is ready for R package development work."
            echo "Copilot can now build, test, lint, and create reproducible examples."
          else
            echo "✓ Minimal environment configured:"
            echo "  - Repository checked out and ready"
            echo "  - R setup SKIPPED - only documentation/config changes detected"
            echo ""
            if [ "${GITHUB_EVENT_NAME:-}" = "pull_request" ]; then
              echo "Decision based on PR file analysis using GitHub API"
            else
              echo "Decision based on git diff analysis"
            fi
            echo "The environment is ready for documentation and configuration work."
            echo "Perfect for version bumps, NEWS.md updates, and text editing tasks."
          fi
        shell: bash
